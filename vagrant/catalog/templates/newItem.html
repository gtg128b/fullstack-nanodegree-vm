<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Life is good, think about it</title>
        <link rel="icon" type="image/jpg" href="{{ url_for("static", filename="favicon.png") }}">
        <link rel="stylesheet" type="text/css" href="{{ url_for("static", filename="styles.css") }}"> 
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script src="https://apis.google.com/js/platform.js?onload=start" async defer> </script>
        <!--info: https://developers.google.com/identity/sign-in/web/reference#gapiauth2clientconfig-->
        <!--this script provided by Ellis E: https://knowledge.udacity.com/questions/56880-->
        <script>
            function start() { 
                gapi.load('auth2', function() {
                    auth2 = gapi.auth2.init({
                        client_id: '364182773543-0tuco9r609d9itai02u1uotdonc41dad.apps.googleusercontent.com'
                    });
                    // Listen for sign-in state changes
                //    auth2.isSignedIn.listen(signinChanged);
                    // Listen for changes to current user
                //    auth2.currentUser.listen(userChanged);
                    // Sign in the user if they are currently signed in
                    //if (auth2.isSignedIn.get() == true) {
                    //    auth2.signIn();
                    //}
                    // Start with the current live values
                //    refreshValues();
                });

                /**
                * Listener method for sign-out live value.
                *
                * @param {boolean} val the updated signed out state.
                */
                var signinChanged = function (val) {
                console.log('Signin state changed to ', val);
                //document.getElementById('signed-in-cell').innerText = val;
                };

                /**
                * Listener method for when the user changes.
                *
                * @param {GoogleUser} user the updated user.
                */
                var userChanged = function (user) {
                console.log('User now: ', user);
                googleUser = user;
                updateGoogleUser();
                //document.getElementById('curr-user-cell').innerText =
                //   JSON.stringify(user, undefined, 2);
                };

                /**
                * Updates the properties in the Google User table using the current user.
                */
                var updateGoogleUser = function () {
                    if (googleUser) {
                        console.log('User logged in');
                        //document.getElementById('user-id').innerText = googleUser.getId();
                        //document.getElementById('user-scopes').innerText =
                        //googleUser.getGrantedScopes();
                        //document.getElementById('auth-response').innerText =
                        //JSON.stringify(googleUser.getAuthResponse(), undefined, 2);
                        //$('#signinButton').attr('style', 'display:none');
                        //$('#signoutButton').attr('style', 'display:inline');
                    } else {
                        console.log('User logged out');
                        //document.getElementById('user-id').innerText = '--';
                        //document.getElementById('user-scopes').innerText = '--';
                        //document.getElementById('auth-response').innerText = '--';
                        //$('#signinButton').attr('style', 'display:inline');
                        //$('#signoutButton').attr('style', 'display:none'); 
                    }
                };

                /**
                * Retrieves the current user and signed in states from the GoogleAuth
                * object.
                */
                var refreshValues = function() {
                    if (auth2){
                        console.log('Refreshing values...');

                        googleUser = auth2.currentUser.get();

                        //document.getElementById('curr-user-cell').innerText =
                        //JSON.stringify(googleUser, undefined, 2);
                        //document.getElementById('signed-in-cell').innerText =
                        //auth2.isSignedIn.get();

                        updateGoogleUser();
                    }
                }
/*                     if ('user_id' in session) {
                        $('#signinButton').attr('style', 'display:none');
                        $('#signoutButton').attr('style', 'display:inline');
                    } else {
                        $('#signinButton').attr('style', 'display:inline');
                        $('#signoutButton').attr('style', 'display:none'); 
                    }  */
            }
        </script>
    </head>
    <body>
    <div class="banner">
        <table>
            <tr>
                <td>
                    <h1>Item Catalog</h1> 
                </td>
                <td class="login">
                    <div> <!-- class="g-signin2" data-onsuccess="onSignIn"> -->
                        {%if 'user_id' not in session %}
                            <img id="signinButton" class="btn btn-primary" src="{{ url_for("static", filename="gsign_in.png") }}" />
                        {% else %}
                            <img id="signoutButton" class="btn btn-primary" src="{{ url_for("static", filename="gsign_out.png") }}" />
                        {% endif %}
                    </div>
                </td>
            </tr>
        </table>
    </div>
    <div class="inset">
        <table class="tablet">
            <tr>
                <td> 
                    <h2>New Catalog Item</h2>
                    {%if 'user_id' not in session %}
                        <h3>You must login to add an Item.</h3>
                        <a href="{{url_for("showLogin" )}}">Return</a>
                    {% else %}
                        <form action="{{ url_for("newItem" )}}" method="POST">
                            <h3>Category</h3><br/>
                            <select name="selectedCategory">
                                {% for c in category %}
                                    <option value={{c.name}}>{{c.name}}</option>
                                {% endfor %}
                            </select><br/>
                            <h3>Title</h3><br/>
                            <input type="text" size="80" name="chosenTitle" placeholder="Enter item name here"><br/>
                            <h3>Description</h3><br/>
                            <input type="text" size="80" name="chosenDescription" rows="4" cols="100" maxlength="250" placeholder="Enter description here"><br/><br/>
                            <input type="submit" value="Create" class="newthingButton"> | <a href="{{url_for("CatalogViewer" )}}">Cancel</a>
                        </form>
                    {% endif %}
                </td>
            </tr>
            <caption class="messaging">
                <br/>
                {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        {% for message in messages %}
                            <h4>{{ message }}</h4>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                <br/>
                <br/>
            </caption>
        </table>
    </div>
    <div id="result"></div>
        <!--this script provided by Ellis E: https://knowledge.udacity.com/questions/56880-->
        <script>
            $('#signinButton').click(function () {
                function signInCallback(authResult) {
                    var auth2 = gapi.auth2.getAuthInstance();
                    if (authResult['code']) {
                        //$('#signinButton').attr('style', 'display:none');
                        //#$('#signoutButton').attr('style',  'display:inline');
                        $.ajax({
                            type: 'POST',
                            url: '/gconnect?state={{STATE}}',
                            processData: false,
                            data: authResult['code'],
                            contentType: 'application/octet-stream; charset=utf8',
                            success: function (result) {
                                if (result) {
                                    $('#result').html('<br/><br/>Login Successful!<br/>' + result + '<br/>Redirecting...');
                                    setTimeout(function () {window.location.href = "http://localhost:8000/";}, 550);
                                } else if (authResult['error']) {
                                    $('#result').html('<br/><br/>Auth code retrieval failed!<br/>' + authResult['error'] + '<br/>Redirecting...');
                                    setTimeout(function () {window.location.href = "http://localhost:8000/login";}, 550);
                                    console.log('There was an error: ' + authResult['error']);
                                } else {
                                    $('#result').html('<br/><br/>Failed to make a server-side call. Check your configuration and console.');
                                    setTimeout(function () {window.location.href = "http://localhost:8000/login";}, 550);
                                    console.log('Unable to contact remote system');
                                }
                                $('#signinButton').attr('style', 'display:none');
                                $('#signoutButton').attr('style',  'display:inline');
                            }
                        });
                    } else {
                        console.log('There was an error with code object');
                    }
                }
                auth2.grantOfflineAccess().then(signInCallback);
            })
            $('#signoutButton').click(function () {
                function signOut() {
                    var auth2 = gapi.auth2.getAuthInstance();
                    $.ajax({
                        type: 'POST',
                        url: '/gdisconnect',
                        contentType: 'applciation/octet-stream; charset=utf8',
                        success: function (result) {
                            $('#result').html('<br/><br/>Logout Successful!<br/>' + result + '<br/>Redirecting...');
                            setTimeout(function () { window.location.href = "http://localhost:8000/login";}, 1000);
                            $('#signinButton').attr('style', 'display:inline');
                            $('#signoutButton').attr('style',  'display:none');
                            console.log('User signed out.');
                        }
                    });
                ;}
                auth2.signOut().then(signOut);
            })
        </script>
    </body>
</html>
